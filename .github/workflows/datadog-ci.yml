name: Datadog CI Integration

on:
  workflow_call:
    inputs:
      datadog-api-key:
        required: true
        type: string
        description: 'Datadog API key for CI metrics and logs'
      datadog-site:
        required: false
        type: string
        default: 'datadoghq.com'
        description: 'Datadog site (datadoghq.com, datadoghq.eu, etc.)'
      service-name:
        required: true
        type: string
        description: 'Service name for Datadog metrics'
      environment:
        required: false
        type: string
        default: 'ci'
        description: 'Environment name'
      tags:
        required: false
        type: string
        default: 'ci:true'
        description: 'Additional tags for metrics (comma-separated)'

jobs:
  datadog-setup:
    runs-on: ubuntu-latest
    outputs:
      dd-trace-id: ${{ steps.datadog-setup.outputs.trace-id }}
      dd-span-id: ${{ steps.datadog-setup.outputs.span-id }}
    steps:
      - name: Setup Datadog CI
        id: datadog-setup
        run: |
          echo "trace-id=$(date +%s)" >> $GITHUB_OUTPUT
          echo "span-id=$(date +%s)" >> $GITHUB_OUTPUT

  datadog-monitor:
    runs-on: ubuntu-latest
    needs: datadog-setup
    if: always()
    steps:
      - name: Send CI metrics to Datadog
        run: |
          curl -X POST "https://api.${{ inputs.datadog-site }}/api/v1/series" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ inputs.datadog-api-key }}" \
            -d '{
              "series": [{
                "metric": "github.ci.pipeline.duration",
                "points": [[$(date +%s), ${{ github.run_duration }}]],
                "tags": ["service:${{ inputs.service-name }}", "env:${{ inputs.environment }}", "workflow:${{ github.workflow }}", "job:${{ github.job }}"],
                "type": "gauge"
              }, {
                "metric": "github.ci.pipeline.status",
                "points": [[$(date +%s), 1]],
                "tags": ["service:${{ inputs.service-name }}", "env:${{ inputs.environment }}", "workflow:${{ github.workflow }}", "job:${{ github.job }}", "status:${{ job.status }}"],
                "type": "gauge"
              }, {
                "metric": "github.ci.repository.workflow_runs",
                "points": [[$(date +%s), 1]],
                "tags": ["service:${{ inputs.service-name }}", "env:${{ inputs.environment }}", "repo:${{ github.repository }}", "branch:${{ github.ref_name }}"],
                "type": "gauge"
              }, {
                "metric": "github.ci.job.duration",
                "points": [[$(date +%s), ${{ github.run_duration }}]],
                "tags": ["service:${{ inputs.service-name }}", "env:${{ inputs.environment }}", "job:${{ github.job }}", "runner:${{ runner.os }}"],
                "type": "gauge"
              }]
            }'

      - name: Send CI events to Datadog
        if: always()
        run: |
          curl -X POST "https://api.${{ inputs.datadog-site }}/api/v1/events" \
            -H "Content-Type: application/json" \
            -H "DD-API-KEY: ${{ inputs.datadog-api-key }}" \
            -d '{
              "title": "Lace CI Pipeline: ${{ github.workflow }}",
              "text": "Workflow ${{ github.workflow }} completed with status: ${{ job.status }}\nRepository: ${{ github.repository }}\nBranch: ${{ github.ref_name }}\nCommit: ${{ github.sha }}",
              "tags": ["service:${{ inputs.service-name }}", "env:${{ inputs.environment }}", "workflow:${{ github.workflow }}", "status:${{ job.status }}", "repo:${{ github.repository }}"],
              "alert_type": "${{ job.status == 'success' && 'info' || 'error' }}",
              "source_type_name": "github"
            }' 